<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stator Winding Data - Entry Form with Image</title>

  <!-- Bootstrap 5.3.8 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0ea5a4;
    }
    body{background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .topbar{display:flex;flex-wrap:wrap;justify-content:space-between;gap:12px;align-items:center;margin:18px 0}
    .card-custom{background:var(--card);border-radius:.6rem;padding:18px;box-shadow:0 6px 18px rgba(12,22,42,.06)}
    .grid .form-control, .grid .form-select{min-height:42px}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .pitches .pitch-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .preview{display:block;margin-top:8px;max-width:120px;max-height:120px;border-radius:6px;object-fit:cover;border:1px solid #e9eef1}
    .small-muted{color:var(--muted);font-size:.85rem}
    @media (min-width: 992px){
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    }
    @media (max-width: 991px){
      .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    }
    @media (max-width: 576px){
      .grid{grid-template-columns:1fr}
    }
    #dataTable img{max-width:80px;max-height:60px;object-fit:cover;border-radius:4px}
    .btn-ghost{background:transparent;border:1px dashed #cbd5e1}
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="topbar">
      <h1 class="h4 mb-0">Stator Winding Data â€” Entry</h1>
      <div class="d-flex gap-2">
        <input id="search" class="form-control form-control-sm" placeholder="Search by name, type, hp..." />
        <button id="exportBtn" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-spreadsheet-fill"></i> Export XLSX</button>
      </div>
    </div>

    <div class="card-custom">
      <form id="dataForm" autocomplete="off" novalidate>
        <div class="grid">
          <div>
            <label for="date" class="form-label small-muted">Date</label>
            <input type="date" id="date" class="form-control" required />
          </div>
          <div>
            <label for="name" class="form-label small-muted">Name</label>
            <input type="text" id="name" class="form-control" placeholder="Customer / Motor name" required />
          </div>
          <div>
            <label for="type" class="form-label small-muted">Type</label>
            <input type="text" id="type" class="form-control" placeholder="e.g. Induction, Universal" />
          </div>

          <div>
            <label for="phase" class="form-label small-muted">Phase</label>
            <select id="phase" class="form-select">
                <option value="Single">Single</option>
                <option value="Three">Three</option>
            </select>
          </div>

          <div>
            <label for="hp" class="form-label small-muted">HP</label>
            <input type="number" id="hp" step="0.1" class="form-control" placeholder="Horsepower" />
          </div>

          <div>
            <label for="kw" class="form-label small-muted">kW</label>
            <input type="number" id="kw" step="0.01" class="form-control" placeholder="Kilowatt" />
          </div>

          <div>
            <label for="rpm" class="form-label small-muted">RPM</label>
            <input type="number" id="rpm" class="form-control" placeholder="Revolutions per minute" />
          </div>

          <div>
            <label for="current" class="form-label small-muted">Current (A)</label>
            <input type="number" id="current" step="0.01" class="form-control" />
          </div>

          <div>
            <label for="capacitor" class="form-label small-muted">Capacitor</label>
            <input type="text" id="capacitor" class="form-control" placeholder="uF / Type" />
          </div>

          <div>
            <label for="diameter" class="form-label small-muted">Diameter (mm)</label>
            <input type="number" id="diameter" step="0.01" class="form-control" />
          </div>

          <div>
            <label for="length" class="form-label small-muted">Length (mm)</label>
            <input type="number" id="length" step="0.01" class="form-control" />
          </div>

          <div>
            <label for="image" class="form-label small-muted">Product Image</label>
            <input type="file" id="image" class="form-control" accept="image/*" />
            <img id="preview" class="preview" src="" alt="" />
          </div>
        </div>

        <div class="section-title mt-3">
          <strong>Starting Pitch(s)</strong>
          <button type="button" id="addStartPitch" class="btn btn-sm btn-outline-primary">+ Add Starting Pitch</button>
        </div>
        <div id="startingPitches" class="pitches"></div>

        <div class="section-title mt-3">
          <strong>Running Pitch(s)</strong>
          <button type="button" id="addRunPitch" class="btn btn-sm btn-outline-primary">+ Add Running Pitch</button>
        </div>
        <div id="runningPitches" class="pitches"></div>

        <div class="d-flex gap-2 align-items-center flex-wrap mt-3">
          <button type="submit" class="btn btn-primary">Save Entry</button>
          <button type="button" id="clearForm" class="btn btn-outline-secondary">Clear</button>
          <small class="small-muted ms-2">You can add multiple pitch rows; values are saved as float arrays.</small>
        </div>
      </form>

      <hr class="my-3">

      <div id="tableWrap" class="table-responsive">
        <table id="dataTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th><th>Name</th><th>Type</th><th>Phase</th><th>HP</th><th>kW</th><th>RPM</th><th>Current</th><th>Capacitor</th><th>Diameter</th><th>Length</th><th>Image</th><th>Starting Pitch(s)</th><th>Running Pitch(s)</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const startingPitches = $('startingPitches');
    const runningPitches = $('runningPitches');
    const addStartPitch = $('addStartPitch');
    const addRunPitch = $('addRunPitch');
    const preview = $('preview');
    const imageInput = $('image');
    const dataForm = $('dataForm');
    const tableBody = document.querySelector('#dataTable tbody');
    const exportBtn = $('exportBtn');
    const search = $('search');
    const clearFormBtn = $('clearForm');

    let entries = JSON.parse(localStorage.getItem('stator_entries') || '[]');

    function pitchRowHTML(kind, idx){
      return `
      <div class="pitch-row border rounded p-2" data-kind="${kind}" data-idx="${idx}">
        <div class="row g-2 w-100">
          <div class="col-6 col-sm-3">
            <label class="form-label small-muted">Set</label>
            <select class="form-select pitch-set">
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option><option value="8">8</option><option value="10">10</option>
              <option value="12">12</option>
            </select>
          </div>
          <div class="col-6 col-sm-3">
            <label class="form-label small-muted">Turns</label>
            <input class="form-control pitch-turns" placeholder="e.g. 18" />
          </div>
          <div class="col-6 col-sm-3">
            <label class="form-label small-muted">Gauge</label>
            <input class="form-control pitch-gauge" placeholder="e.g. 18" />
          </div>
          <div class="col-6 col-sm-3">
            <label class="form-label small-muted">Weight (kg)</label>
            <input class="form-control pitch-weight" type="number" step="0.001" placeholder="kg" />
          </div>
          <div class="col-12 col-sm-2 d-flex align-items-end">
            <button type="button" class="btn btn-sm btn-danger remove-pitch w-100">Remove</button>
          </div>
        </div>
      </div>`;
    }

    function addPitch(container, kind){
      const idx = container.children.length;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = pitchRowHTML(kind, idx);
      container.appendChild(wrapper.firstElementChild);
    }

    addStartPitch.addEventListener('click', ()=> addPitch(startingPitches,'start'));
    addRunPitch.addEventListener('click', ()=> addPitch(runningPitches,'run'));

    document.addEventListener('click', e=>{
      if(e.target.matches('.remove-pitch')){
        e.target.closest('.pitch-row').remove();
      }
    });

    imageInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(!f){ preview.src=''; return; }
      const reader = new FileReader();
      reader.onload = evt => preview.src = evt.target.result;
      reader.readAsDataURL(f);
    });

    dataForm.addEventListener('submit', e=>{
      e.preventDefault();
      const entry = {
        date: $('date').value || '',
        name: $('name').value || '',
        type: $('type').value || '',
        phase: $('phase').value || '',
        hp: parseFloat($('hp').value) || '',
        kw: parseFloat($('kw').value) || '',
        rpm: parseFloat($('rpm').value) || '',
        current: parseFloat($('current').value) || '',
        capacitor: $('capacitor').value || '',
        diameter: parseFloat($('diameter').value) || '',
        length: parseFloat($('length').value) || '',
        imageData: preview.src || '',
        startingPitches: collectPitches(startingPitches),
        runningPitches: collectPitches(runningPitches),
        createdAt: new Date().toISOString()
      };
      entries.unshift(entry);
      localStorage.setItem('stator_entries', JSON.stringify(entries));
      renderTable(entries);
      dataForm.reset();
      preview.src='';
      startingPitches.innerHTML='';
      runningPitches.innerHTML='';
    });

    function collectPitches(container){
      return [...container.querySelectorAll('.pitch-row')].map(r => ({
        set: parseFloat(r.querySelector('.pitch-set').value) || 0,
        turns: parseFloat(r.querySelector('.pitch-turns').value) || 0,
        gauge: r.querySelector('.pitch-gauge').value || '',
        weight: parseFloat(r.querySelector('.pitch-weight').value) || 0
      }));
    }

    function renderTable(list){
      tableBody.innerHTML='';
      list.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.date}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${escapeHtml(it.type)}</td>
          <td>${it.phase}</td>
          <td>${it.hp}</td>
          <td>${it.kw}</td>
          <td>${it.rpm}</td>
          <td>${it.current}</td>
          <td>${escapeHtml(it.capacitor)}</td>
          <td>${it.diameter}</td>
          <td>${it.length}</td>
          <td>${it.imageData ? `<img src="${it.imageData}" alt="">` : ''}</td>
          <td>${formatPitchColumn(it.startingPitches)}</td>
          <td>${formatPitchColumn(it.runningPitches)}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary view-entry" data-idx="${idx}"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-danger delete-entry" data-idx="${idx}"><i class="bi bi-trash"></i></button>
            </div>
          </td>`;
        tableBody.appendChild(tr);
      });
    }

    function formatPitchColumn(pitches){
      return (pitches||[]).map(p=>`[S:${p.set},T:${p.turns},G:${escapeHtml(p.gauge)},W:${p.weight}kg]`).join('<br>');
    }
    function escapeHtml(s){ return String(s||'').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    tableBody.addEventListener('click', e=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const idx = +btn.dataset.idx;
      if(btn.classList.contains('delete-entry')){
        if(confirm('Delete this entry?')){
          entries.splice(idx,1);
          localStorage.setItem('stator_entries', JSON.stringify(entries));
          renderTable(entries);
        }
      }
      if(btn.classList.contains('view-entry')){
        const it = entries[idx];
        if(!it) return;
        $('date').value = it.date || '';
        $('name').value = it.name || '';
        $('type').value = it.type || '';
        $('phase').value = it.phase || 'Single';
        $('hp').value = it.hp || '';
        $('kw').value = it.kw || '';
        $('rpm').value = it.rpm || '';
        $('current').value = it.current || '';
        $('capacitor').value = it.capacitor || '';
        $('diameter').value = it.diameter || '';
        $('length').value = it.length || '';
        preview.src = it.imageData || '';
        startingPitches.innerHTML='';
        runningPitches.innerHTML='';
        (it.startingPitches||[]).forEach(p=>{
          addPitch(startingPitches,'start');
          const row = startingPitches.lastElementChild;
          row.querySelector('.pitch-set').value = p.set || 4;
          row.querySelector('.pitch-turns').value = p.turns || '';
          row.querySelector('.pitch-gauge').value = p.gauge || '';
          row.querySelector('.pitch-weight').value = p.weight || '';
        });
        (it.runningPitches||[]).forEach(p=>{
          addPitch(runningPitches,'run');
          const row = runningPitches.lastElementChild;
          row.querySelector('.pitch-set').value = p.set || 4;
          row.querySelector('.pitch-turns').value = p.turns || '';
          row.querySelector('.pitch-gauge').value = p.gauge || '';
          row.querySelector('.pitch-weight').value = p.weight || '';
        });
        window.scrollTo({top:0,behavior:'smooth'});
      }
    });

    search.addEventListener('input', ()=>{
      const q = search.value.trim().toLowerCase();
      const filtered = entries.filter(it =>
        (it.name||'').toLowerCase().includes(q) ||
        (it.type||'').toLowerCase().includes(q) ||
        (it.phase||'').toLowerCase().includes(q) ||
        String(it.hp||'').includes(q)
      );
      renderTable(filtered);
    });

    clearFormBtn.addEventListener('click', ()=>{
      if(confirm('Clear form and remove added pitch rows?')){
        dataForm.reset();
        preview.src='';
        startingPitches.innerHTML='';
        runningPitches.innerHTML='';
      }
    });

    exportBtn.addEventListener('click', ()=>{
      if(!entries.length){ alert('No entries to export'); return; }
      const rows = entries.map(it=>({
        Date: it.date,
        Name: it.name,
        Type: it.type,
        Phase: it.phase,
        HP: it.hp,
        kW: it.kw,
        RPM: it.rpm,
        Current: it.current,
        Capacitor: it.capacitor,
        Diameter_mm: it.diameter,
        Length_mm: it.length,
        Starting_Pitches: (it.startingPitches||[]).map(p=>`S:${p.set},T:${p.turns},G:${p.gauge},W:${p.weight}kg`).join('; '),
        Running_Pitches: (it.runningPitches||[]).map(p=>`S:${p.set},T:${p.turns},G:${p.gauge},W:${p.weight}kg`).join('; '),
        CreatedAt: it.createdAt
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'StatorWinding');
      XLSX.writeFile(wb, `stator_winding_entries_${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    renderTable(entries);
    if(startingPitches.children.length===0) addPitch(startingPitches,'start');
    if(runningPitches.children.length===0) addPitch(runningPitches,'run');
  })();
  </script>
</body>
</html>
