<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stator Winding Data - Entry Form with Image</title>

  <!-- Bootstrap 5.3.8 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0ea5a4;
    }
    body{background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .topbar{display:flex;flex-wrap:wrap;justify-content:space-between;gap:12px;align-items:center;margin:18px 0}
    .card-custom{background:var(--card);border-radius:.6rem;padding:18px;box-shadow:0 6px 18px rgba(12,22,42,.06)}
    .grid .form-control, .grid .form-select{min-height:42px}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .pitches .pitch-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .pitch-chip{display:inline-flex;align-items:center;border-radius:6px;padding:6px 8px;background:#f1f5f9;border:1px solid #e6eef0}
    .preview{display:block;margin-top:8px;max-width:120px;max-height:120px;border-radius:6px;object-fit:cover;border:1px solid #e9eef1}
    .small-muted{color:var(--muted);font-size:.85rem}
    @media (min-width: 992px){
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    }
    @media (max-width: 991px){
      .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    }
    @media (max-width: 576px){
      .grid{grid-template-columns:1fr}
    }
    #dataTable img{max-width:80px;max-height:60px;object-fit:cover;border-radius:4px}
    .btn-ghost{background:transparent;border:1px dashed #cbd5e1}
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="topbar">
      <h1 class="h4 mb-0">Stator Winding Data â€” Entry</h1>
      <div class="d-flex gap-2">
        <input id="search" class="form-control form-control-sm" placeholder="Search by name, type, hp..." />
        <button id="exportBtn" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-spreadsheet-fill"></i> Export XLSX</button>
      </div>
    </div>

    <div class="card-custom">
      <form id="dataForm" autocomplete="off" novalidate>
        <div class="grid">
          <div>
            <label for="date" class="form-label small-muted">Date</label>
            <input type="date" id="date" class="form-control" required />
          </div>
          <div>
            <label for="name" class="form-label small-muted">Name</label>
            <input type="text" id="name" class="form-control" placeholder="Customer / Motor name" required />
          </div>
          <div>
            <label for="type" class="form-label small-muted">Type</label>
            <input type="text" id="type" class="form-control" placeholder="e.g. Induction, Universal" />
          </div>

          <div>
            <label for="phase" class="form-label small-muted">Phase</label>
            <select id="phase" class="form-select">
                <option value="Single">Single</option>
                <option value="Three">Three</option>
            </select>
          </div>

          <div>
            <label for="hp" class="form-label small-muted">HP</label>
            <input type="number" id="hp" step="0.1" class="form-control" placeholder="Horsepower" />
          </div>

          <div>
            <label for="kw" class="form-label small-muted">kW</label>
            <input type="number" id="kw" step="0.01" class="form-control" placeholder="Kilowatt" />
          </div>

          <div>
            <label for="rpm" class="form-label small-muted">RPM</label>
            <input type="number" id="rpm" class="form-control" placeholder="Revolutions per minute" />
          </div>

          <div>
            <label for="current" class="form-label small-muted">Current (A)</label>
            <input type="number" id="current" step="0.01" class="form-control" />
          </div>

          <div>
            <label for="capacitor" class="form-label small-muted">Capacitor</label>
            <input type="text" id="capacitor" class="form-control" placeholder="uF / Type" />
          </div>

          <div>
            <label for="diameter" class="form-label small-muted">Diameter (mm)</label>
            <input type="number" id="diameter" step="0.01" class="form-control" />
          </div>

          <div>
            <label for="length" class="form-label small-muted">Length (mm)</label>
            <input type="number" id="length" step="0.01" class="form-control" />
          </div>

          <div>
            <label for="image" class="form-label small-muted">Product Image</label>
            <input type="file" id="image" class="form-control" accept="image/*" />
            <img id="preview" class="preview" src="" alt="" />
          </div>
        </div>

        <div class="section-title mt-3">
          <strong>Starting Pitch(s)</strong>
          <button type="button" id="addStartPitch" class="btn btn-sm btn-outline-primary">+ Add Starting Pitch</button>
        </div>
        <div id="startingPitches" class="pitches"></div>

        <div class="section-title mt-3">
          <strong>Running Pitch(s)</strong>
          <button type="button" id="addRunPitch" class="btn btn-sm btn-outline-primary">+ Add Running Pitch</button>
        </div>
        <div id="runningPitches" class="pitches"></div>

        <div class="d-flex gap-2 align-items-center flex-wrap mt-3">
          <button type="submit" class="btn btn-primary">Save Entry</button>
          <button type="button" id="clearForm" class="btn btn-ghost btn-ghost btn-ghost btn-ghost btn btn-outline-secondary">Clear</button>
          <small class="small-muted ms-2">You can add multiple pitch rows; values are saved as float arrays.</small>
        </div>
      </form>

      <hr class="my-3">

      <div id="tableWrap" class="table-responsive">
        <table id="dataTable" class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th><th>Name</th><th>Type</th><th>Phase</th><th>HP</th><th>kW</th><th>RPM</th><th>Current</th><th>Capacitor</th><th>Diameter</th><th>Length</th><th>Image</th><th>Starting Pitch(s)</th><th>Running Pitch(s)</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Keep original field IDs and structure intact while enhancing functionality.
    (function(){
      // Utilities
      const $ = id => document.getElementById(id);
      const startingPitches = $('startingPitches');
      const runningPitches = $('runningPitches');
      const addStartPitch = $('addStartPitch');
      const addRunPitch = $('addRunPitch');
      const preview = $('preview');
      const imageInput = $('image');
      const dataForm = $('dataForm');
      const tableBody = document.querySelector('#dataTable tbody');
      const exportBtn = $('exportBtn');
      const search = $('search');
      const clearFormBtn = $('clearForm');

      // maintain entries array
      let entries = JSON.parse(localStorage.getItem('stator_entries') || '[]');

      // pitch template
      function pitchRowHTML(kind, idx){
        // kind: 'start' or 'run'
        return `
        <div class="pitch-row border rounded p-2" data-kind="${kind}" data-idx="${idx}">
          <div class="row g-2 w-100">
            <div class="col-12 col-sm-3">
              <label class="form-label small-muted">Turns (set)</label>
              <select class="form-select pitch-turn" >
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="10">10</option>
                <option value="12">12</option>
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label class="form-label small-muted">Gauge</label>
              <input class="form-control pitch-gauge" placeholder="e.g. 18" />
            </div>
            <div class="col-12 col-sm-3">
              <label class="form-label small-muted">Weight (kg)</label>
              <input class="form-control pitch-weight" type="number" step="0.001" placeholder="kg" />
            </div>
            <div class="col-12 col-sm-2 d-flex align-items-end">
              <button type="button" class="btn btn-sm btn-danger remove-pitch w-100">Remove</button>
            </div>
          </div>
        </div>`;
      }

      function addPitch(container, kind){
        const idx = container.children.length;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = pitchRowHTML(kind, idx);
        container.appendChild(wrapper.firstElementChild);
      }

      addStartPitch.addEventListener('click', ()=> addPitch(startingPitches,'start'));
      addRunPitch.addEventListener('click', ()=> addPitch(runningPitches,'run'));

      // remove pitch (event delegation)
      document.addEventListener('click', (e)=>{
        if(e.target.matches('.remove-pitch')){
          const row = e.target.closest('.pitch-row');
          row.remove();
        }
      });

      // image preview
      imageInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f){ preview.src=''; return; }
        const reader = new FileReader();
        reader.onload = function(evt){
          preview.src = evt.target.result;
        };
        reader.readAsDataURL(f);
      });

      // form submission -> save entry
      dataForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const entry = {
          date: $('date').value || '',
          name: $('name').value || '',
          type: $('type').value || '',
          phase: $('phase').value || '',
          hp: parseFloat($('hp').value || '') || '',
          kw: parseFloat($('kw').value || '') || '',
          rpm: parseFloat($('rpm').value || '') || '',
          current: parseFloat($('current').value || '') || '',
          capacitor: $('capacitor').value || '',
          diameter: parseFloat($('diameter').value || '') || '',
          length: parseFloat($('length').value || '') || '',
          imageData: preview.src || '',
          startingPitches: collectPitches(startingPitches),
          runningPitches: collectPitches(runningPitches),
          createdAt: new Date().toISOString()
        };
        entries.unshift(entry);
        localStorage.setItem('stator_entries', JSON.stringify(entries));
        renderTable(entries);
        dataForm.reset();
        preview.src='';
        // clear pitch containers
        startingPitches.innerHTML='';
        runningPitches.innerHTML='';
      });

      function collectPitches(container){
        const rows = Array.from(container.querySelectorAll('.pitch-row'));
        return rows.map(r => {
          const turns = parseFloat(r.querySelector('.pitch-turn').value) || 0;
          const gauge = r.querySelector('.pitch-gauge').value || '';
          const weight = parseFloat(r.querySelector('.pitch-weight').value || 0) || 0;
          return {turns, gauge, weight};
        });
      }

      // render table
      function renderTable(list){
        tableBody.innerHTML='';
        list.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.date}</td>
            <td>${escapeHtml(it.name)}</td>
            <td>${escapeHtml(it.type)}</td>
            <td>${it.phase}</td>
            <td>${isFiniteNumber(it.hp)?it.hp:''}</td>
            <td>${isFiniteNumber(it.kw)?it.kw:''}</td>
            <td>${isFiniteNumber(it.rpm)?it.rpm:''}</td>
            <td>${isFiniteNumber(it.current)?it.current:''}</td>
            <td>${escapeHtml(it.capacitor)}</td>
            <td>${isFiniteNumber(it.diameter)?it.diameter:''}</td>
            <td>${isFiniteNumber(it.length)?it.length:''}</td>
            <td>${it.imageData? `<img src="${it.imageData}" alt="img">` : ''}</td>
            <td>${formatPitchColumn(it.startingPitches)}</td>
            <td>${formatPitchColumn(it.runningPitches)}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary view-entry" data-idx="${idx}"><i class="bi bi-eye"></i></button>
                <button class="btn btn-outline-danger delete-entry" data-idx="${idx}"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          `;
          tableBody.appendChild(tr);
        });
      }

      // small helpers
      function formatPitchColumn(pitches){
        if(!pitches || pitches.length===0) return '';
        return pitches.map(p=>`[${p.turns}T, G:${escapeHtml(p.gauge || '')}, ${parseFloat(p.weight||0)}kg]`).join('<br>');
      }
      function escapeHtml(s){ return String(s).replaceAll('<','&lt;').replaceAll('>','&gt;'); }
      function isFiniteNumber(v){ return v!=='' && v!==null && v!==undefined && !Number.isNaN(Number(v)); }

      // view/delete event delegation
      tableBody.addEventListener('click', (e)=>{
        if(e.target.closest('.delete-entry')){
          const idx = e.target.closest('.delete-entry').dataset.idx;
          // entries are stored newest-first, idx corresponds accordingly
          if(confirm('Delete this entry?')){
            entries.splice(idx,1);
            localStorage.setItem('stator_entries', JSON.stringify(entries));
            renderTable(entries);
          }
        }
        if(e.target.closest('.view-entry')){
          const idx = e.target.closest('.view-entry').dataset.idx;
          const it = entries[idx];
          if(!it) return;
          // populate form for quick edit (not a full edit workflow - simple quick load)
          $('date').value = it.date || '';
          $('name').value = it.name || '';
          $('type').value = it.type || '';
          $('phase').value = it.phase || 'Single';
          $('hp').value = it.hp || '';
          $('kw').value = it.kw || '';
          $('rpm').value = it.rpm || '';
          $('current').value = it.current || '';
          $('capacitor').value = it.capacitor || '';
          $('diameter').value = it.diameter || '';
          $('length').value = it.length || '';
          preview.src = it.imageData || '';
          // clear and re-add pitch rows
          startingPitches.innerHTML='';
          runningPitches.innerHTML='';
          (it.startingPitches||[]).forEach(()=>addPitch(startingPitches,'start'));
          (it.runningPitches||[]).forEach(()=>addPitch(runningPitches,'run'));
          // now fill the newly added pitch rows with values
          const spRows = startingPitches.querySelectorAll('.pitch-row');
          (it.startingPitches||[]).forEach((p,i)=>{
            if(spRows[i]){
              spRows[i].querySelector('.pitch-turn').value = p.turns || spRows[i].querySelector('.pitch-turn').value;
              spRows[i].querySelector('.pitch-gauge').value = p.gauge || '';
              spRows[i].querySelector('.pitch-weight').value = p.weight || '';
            }
          });
          const rpRows = runningPitches.querySelectorAll('.pitch-row');
          (it.runningPitches||[]).forEach((p,i)=>{
            if(rpRows[i]){
              rpRows[i].querySelector('.pitch-turn').value = p.turns || rpRows[i].querySelector('.pitch-turn').value;
              rpRows[i].querySelector('.pitch-gauge').value = p.gauge || '';
              rpRows[i].querySelector('.pitch-weight').value = p.weight || '';
            }
          });
          window.scrollTo({top:0,behavior:'smooth'});
        }
      });

      // search filter
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        if(!q){ renderTable(entries); return; }
        const filtered = entries.filter(it => {
          return (it.name||'').toLowerCase().includes(q) ||
                 (it.type||'').toLowerCase().includes(q) ||
                 String(it.hp||'').toLowerCase().includes(q) ||
                 (it.phase||'').toLowerCase().includes(q);
        });
        renderTable(filtered);
      });

      // clear form button
      clearFormBtn.addEventListener('click', ()=>{
        if(confirm('Clear form and remove added pitch rows?')){
          dataForm.reset();
          preview.src='';
          startingPitches.innerHTML='';
          runningPitches.innerHTML='';
        }
      });

      // Export to Excel (SheetJS)
      exportBtn.addEventListener('click', ()=>{
        if(!entries.length){ alert('No entries to export'); return; }
        // map entries to plain objects suitable for sheet
        const rows = entries.map(it => ({
          Date: it.date,
          Name: it.name,
          Type: it.type,
          Phase: it.phase,
          HP: it.hp,
          kW: it.kw,
          RPM: it.rpm,
          Current: it.current,
          Capacitor: it.capacitor,
          Diameter_mm: it.diameter,
          Length_mm: it.length,
          Image_data_url: it.imageData || '',
          Starting_Pitches: (it.startingPitches||[]).map(p=>`${p.turns}T|${p.gauge}|${p.weight}kg`).join(' ; '),
          Running_Pitches: (it.runningPitches||[]).map(p=>`${p.turns}T|${p.gauge}|${p.weight}kg`).join(' ; '),
          CreatedAt: it.createdAt || ''
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'StatorWinding');
        XLSX.writeFile(wb, `stator_winding_entries_${new Date().toISOString().slice(0,10)}.xlsx`);
      });

      // init: render existing entries
      renderTable(entries);

      // add one empty start and run pitch by default for convenience
      if(startingPitches.children.length === 0) addPitch(startingPitches,'start');
      if(runningPitches.children.length === 0) addPitch(runningPitches,'run');

    })();
  </script>
</body>
</html>
